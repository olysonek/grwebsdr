<!DOCTYPE html>
<html>
<body>
<script>
	var hw_freq = null;
	var privileged = false;

	ws = new WebSocket('ws://' + window.location.hostname + ':8081');
	ws.onopen = function (event) {
		send_freq('0');
	};
	ws.onmessage = function(event) {
		var msg = JSON.parse(event.data);
		if (msg.hasOwnProperty('stream_name')) {
			init_audio(msg.stream_name);
			put_hw_freq(msg);
			update_freq_offset();
		}
		if (msg.hasOwnProperty('privileged')) {
			var btn = document.getElementById('btn_login');
			if (privileged && !msg.privileged) {
				privileged = false;
				btn.innerHTML = 'Login';
			} else if (!privileged && msg.privileged) {
				privileged = true;
				btn.innerHTML = 'Logout';
			} else if (!privileged && !msg.privileged) {
				alert('Login failed.');
			}
		}
	};

	function format_freq(freq) {
		tmp = Math.abs(freq);
		if (tmp >= 1000000)
			return (freq / 1000000.0) + ' MHz';
		else if (tmp >= 1000)
			return (freq / 1000.0) + ' kHz';
		else
			return freq + ' Hz';
	}

	function put_hw_freq(msg) {
		if (msg.hasOwnProperty('hw_freq')) {
			hw_freq = msg.hw_freq;
			var elem = document.getElementById('lbl_hw_freq');
			var freq = format_freq(msg.hw_freq);
			elem.innerHTML = 'HW frequency: ' + freq;
		}
	}

	function send_freq(val) {
		ws.send('{"freq_offset":' + val + '}');
	}

	function update_freq_offset() {
		var freq = parseInt(document.getElementById('freq_offset').value);
		if (hw_freq != null)
			freq += hw_freq;
		freq = format_freq(freq);
		var elem = document.getElementById('lbl_freq_offset');
		elem.innerHTML = 'Freq: ' + freq;
	}

	function init_audio(stream_name) {
		new Audio(stream_name).play();
	}

	function toggle_login() {
		if (privileged)
			ws.send('{"logout":null}');
		else
			ws.send('{"login":null}');
	}

</script>
	<button type="button" id="btn_login" onclick="toggle_login()">Login</button>
	<label id="lbl_freq_offset" for="freq_offset">Freq: 0</label><br>
	<input type="range" id="freq_offset" min="-1000000" max="1000000" value="0"
		step="1" style="border: 1px; width: 90%"
		onchange="send_freq(this.value)"
		oninput="update_freq_offset()"><br>
	<label id="lbl_hw_freq"></label>
</body>
</html>
