<!DOCTYPE html>
<html>
<body>
<script>
	var hw_freq = null;
	var privileged = false;
	var freq_change_requested = true;
	var bandwidth = null;

	ws = new WebSocket('ws://' + window.location.hostname + ':8081');
	ws.onopen = function (event) {
		send_freq_offset('0');
	};
	ws.onmessage = function(event) {
		var msg = JSON.parse(event.data);
		if (msg.hasOwnProperty('stream_name')) {
			init_audio(msg.stream_name);
			update_freq_offset(0);
		}
		update_hw_freq(msg);
		update_bandwidth(msg);
		update_privileged(msg);
	};

	function update_bandwidth(msg) {
		if (msg.hasOwnProperty('bandwidth')) {
			var elem = document.getElementById('freq_offset');
			bandwidth = msg.bandwidth;
			elem.min = -bandwidth/2;
			elem.max = bandwidth/2;
		}
	}

	function update_privileged(msg) {
		if (msg.hasOwnProperty('privileged')) {
			var btn = document.getElementById('btn_login');
			if (privileged && !msg.privileged) {
				privileged = false;
				btn.innerHTML = 'Login';
				removePrivilegedUI();
			} else if (!privileged && msg.privileged) {
				privileged = true;
				btn.innerHTML = 'Logout';
				addPrivilegedUI();
			} else if (!privileged && !msg.privileged) {
				alert('Login failed.');
			}
		}
	}

	function addPrivilegedUI() {
		var form = document.createElement("form");
		form.id = "form_hw_freq";
		form.action = "#";
		form.onsubmit = function() {
			var freq = parseInt(document.getElementById('hw_freq').value);
			freq_change_requested = true;
			ws.send('{"hw_freq":' + freq + '}');
		};

		var e = document.createElement("input");
		e.type = "text";
		e.id = "hw_freq";
		if (hw_freq != null)
			e.value = hw_freq;
		form.appendChild(e);

		e = document.createElement("input");
		e.type = "submit";
		e.value = "Change HW freq";
		form.appendChild(e);

		document.body.appendChild(form);
	}

	function removePrivilegedUI() {
		var e = document.getElementById("form_hw_freq");
		e.outerHTML = "";
		delete e;
	}

	function format_freq(freq) {
		tmp = Math.abs(freq);
		if (tmp >= 1000000)
			return (freq / 1000000.0) + ' MHz';
		else if (tmp >= 1000)
			return (freq / 1000.0) + ' kHz';
		else
			return freq + ' Hz';
	}

	function update_hw_freq(msg) {
		if (msg.hasOwnProperty('hw_freq')) {
			var changed = hw_freq != msg.hw_freq;
			hw_freq = msg.hw_freq;
			var elem = document.getElementById('lbl_hw_freq');
			var freq = format_freq(msg.hw_freq);
			elem.innerHTML = 'HW frequency: ' + freq;
			if (!freq_change_requested && changed) {
				alert('HW frequency changed');
			}
			freq_change_requested = false;
			update_freq_offset(get_freq_offset());
		}
	}

	function send_freq_offset(offset) {
		ws.send('{"freq_offset":' + offset + '}');
	}

	function change_freq_offset_range() {
		var offset = parseInt(document.getElementById("freq_offset").value);
		if (!check_freq_offset(offset))
			return;
		update_freq_offset(offset);
		// No send here. For performance reasons, the offset gets sent
		// only after the mouse button is released (onchange event
		// of the range element)
	}

	function change_freq_offset_txt() {
		if (hw_freq == null)
			return;
		var center_freq = document.getElementById("txt_center_freq").value;
		var offset = center_freq - hw_freq;
		if (!check_freq_offset(offset))
			return;
		update_freq_offset(offset);
		send_freq_offset(offset);
	}

	function check_freq_offset(offset) {
		if (bandwidth == null)
			return false;
		if (offset < -bandwidth / 2 || offset > bandwidth / 2) {
			alert("Frequency out of range");
			return false;
		}
		return true;
	}

	function get_freq_offset() {
		return parseInt(document.getElementById("freq_offset").value);
	}

	function update_freq_offset(offset) {
		document.getElementById("freq_offset").value = offset;
		if (hw_freq == null)
			return;
		var center_freq = offset + hw_freq;
		document.getElementById("txt_center_freq").value = center_freq;
		var freq = format_freq(center_freq);
		var elem = document.getElementById("lbl_center_freq");
		elem.innerHTML = "Center frequency: " + freq;
	}

	function init_audio(stream_name) {
		new Audio(stream_name).play();
	}

	function toggle_login() {
		if (privileged)
			ws.send('{"logout":null}');
		else
			ws.send('{"login":null}');
	}

	function change_demod(val) {
		ws.send('{"demod":"' + val + '"}');
	}

</script>
	<button type="button" id="btn_login" onclick="toggle_login()">Login</button>
	<br>

	<label id="lbl_hw_freq"></label><br>
	<label id="lbl_center_freq" for="freq_offset">Center frequency: 0</label><br>

	<input type="range" id="freq_offset" min="-1000000" max="1000000" value="0"
		step="1" style="border: 1px; width: 90%"
		onchange="send_freq_offset(this.value)"
		oninput="change_freq_offset_range()"><br>

	<form action="#" onsubmit="change_freq_offset_txt()">
		<input type="text" id="txt_center_freq">
		<input type="submit" value="Change center frequency">
	</form><br>

	<label for="select_demod">Demodulation: </label>
	<select onchange="change_demod(this.value)" id="select_demod">
		<option value="WFM">WFM</option>
		<option value="FM">FM</option>
		<option value="AM">AM</option>
		<option value="USB">USB</option>
		<option value="LSB">LSB</option>
		<option value="CW">CW</option>
	</select>
</body>
</html>
